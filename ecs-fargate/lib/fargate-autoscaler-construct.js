"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FargateAutoscalerStack = void 0;
const core = require("@aws-cdk/core");
const lambda = require("@aws-cdk/aws-lambda");
const path = require("path");
const iam = require("@aws-cdk/aws-iam");
const ec2 = require("@aws-cdk/aws-ec2");
const sfn = require("@aws-cdk/aws-stepfunctions");
const sfn_tasks = require("@aws-cdk/aws-stepfunctions-tasks");
const sns = require("@aws-cdk/aws-sns");
const config_1 = require("../configurations/config");
class FargateAutoscalerStack extends core.Construct {
    constructor(parent, name, props) {
        var _a;
        super(parent, name);
        const lambdaRole = new iam.Role(this, "lambdaRole", {
            assumedBy: new iam.ServicePrincipal("lambda.amazonaws.com"),
        });
        lambdaRole.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonECS_FullAccess"));
        lambdaRole.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonEC2ReadOnlyAccess"));
        lambdaRole.addToPolicy(new iam.PolicyStatement({
            resources: ["*"],
            actions: [
                "ec2:CreateNetworkInterface",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DeleteNetworkInterface",
            ],
        }));
        lambdaRole.addToPolicy(new iam.PolicyStatement({
            resources: ["*"],
            actions: [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents",
            ],
        }));
        core.Stack.of(this).templateOptions.transforms = [
            "AWS::Serverless-2016-10-31",
        ]; // required for AWS::Serverless
        const resource = new core.CfnResource(this, "Resource", {
            type: "AWS::Serverless::Application",
            properties: {
                Location: {
                    ApplicationId: props.awsCliLayerArn,
                    SemanticVersion: props.awsCliLayerVersion,
                },
                Parameters: {},
            },
        });
        let layerVersionArn = core.Token.asString(resource.getAtt("Outputs.LayerVersionArn"));
        // create a security group that allows all traffic from the same sg
        const sg = new ec2.SecurityGroup(this, 'SharedSecurityGroup', {
            vpc: props.vpc,
        });
        sg.connections.allowFrom(sg, ec2.Port.allTraffic());
        if (props.scaleType == 'Connection') {
            const fargateWatcherFunc = new lambda.Function(this, "fargateWatcherFunc", {
                runtime: lambda.Runtime.PROVIDED,
                handler: "main",
                code: lambda.Code.fromAsset(path.join(__dirname, "../sam/fargateWatcherFunc/func.d")),
                layers: [
                    lambda.LayerVersion.fromLayerVersionArn(this, "AwsCliLayer", layerVersionArn),
                ],
                memorySize: 1024,
                timeout: core.Duration.minutes(1),
                role: lambdaRole,
                vpc: props.vpc,
                // FIXME
                // vpcSubnets: { subnetType: ec2.SubnetType.PRIVATE },
                securityGroup: sg,
                environment: {
                    cluster: props.cluster.clusterName,
                    service: props.fgService.serviceName,
                    disable_scalein: props.disableScaleIn === false ? "no" : "yes",
                },
            });
            // step function
            const wait3 = new sfn.Wait(this, "Wait " + config_1.applicationMetaData.timeToNextChecker + " Seconds", {
                // time: sfn.WaitTime.secondsPath('$.wait_time')
                time: sfn.WaitTime.duration(core.Duration.seconds(config_1.applicationMetaData.timeToNextChecker)),
            });
            const wait60 = new sfn.Wait(this, "Wait " + config_1.applicationMetaData.waitForSacleDone + " Seconds", {
                time: sfn.WaitTime.duration(core.Duration.seconds(config_1.applicationMetaData.waitForSacleDone)),
            });
            const getEcsTasks = new sfn.Task(this, "GetECSTasks", {
                task: new sfn_tasks.InvokeFunction(fargateWatcherFunc),
                resultPath: "$.status",
            });
            const topic = (_a = props.snsTopic) !== null && _a !== void 0 ? _a : new sns.Topic(this, `${name}-topic`, {
                topicName: `${core.Stack.of(this).stackName}-${name}`,
            });
            const snsScaleOut = new sfn.Task(this, "SNSScaleOut", {
                task: new sfn_tasks.PublishToTopic(topic, {
                    // message: sfn.TaskInput.fromDataAt('$'),
                    message: sfn.TaskInput.fromObject({
                        "Input.$": "$",
                    }),
                    subject: "Fargate Start Scaling Out",
                }),
                resultPath: "$.taskresult",
            });
            const svcScaleOut = new sfn.Task(this, "ServiceScaleOut", {
                task: new sfn_tasks.InvokeFunction(lambda.Function.fromFunctionArn(this, "svcScaleOut", fargateWatcherFunc.functionArn)),
            });
            let desireLv1 = config_1.applicationMetaData.desireLv1.split("_");
            let desireLv2 = config_1.applicationMetaData.desireLv2.split("_");
            let desireLv3 = config_1.applicationMetaData.desireLv3.split("_");
            let desireLv4 = config_1.applicationMetaData.desireLv4.split("_");
            let desireDone = Number(config_1.applicationMetaData.desireDone);
            const isServiceOverloaded = new sfn.Choice(this, "IsServiceOverloaded", {
                inputPath: "$.status",
            });
            const isDone = new sfn.Pass(this, "Done");
            const desire_lv1 = new sfn.Pass(this, "Desire" + desireLv1[1], {
                outputPath: "$",
                result: sfn.Result.fromObject({ Desired: desireLv1[1] }),
            });
            const desire_lv2 = new sfn.Pass(this, "Desire" + desireLv2[1], {
                outputPath: "$",
                result: sfn.Result.fromObject({ Desired: desireLv2[1] }),
            });
            const desire_lv3 = new sfn.Pass(this, "Desire" + desireLv3[1], {
                outputPath: "$",
                result: sfn.Result.fromObject({ Desired: desireLv3[1] }),
            });
            const desire_lv4 = new sfn.Pass(this, "Desire" + desireLv4[1], {
                outputPath: "$",
                result: sfn.Result.fromObject({ Desired: desireLv4[1] }),
            });
            const chain = sfn.Chain.start(getEcsTasks).next(isServiceOverloaded
                .when(sfn.Condition.numberGreaterThanEquals("$.avg", Number(desireLv4[0])), desire_lv4.next(snsScaleOut.next(svcScaleOut.next(wait60.next(getEcsTasks)))))
                .when(sfn.Condition.numberGreaterThanEquals("$.avg", Number(desireLv3[0])), desire_lv3.next(snsScaleOut))
                .when(sfn.Condition.numberGreaterThanEquals("$.avg", Number(desireLv2[0])), desire_lv2.next(snsScaleOut))
                .when(sfn.Condition.numberGreaterThanEquals("$.avg", Number(desireLv1[0])), desire_lv1.next(snsScaleOut))
                // .when(sfn.Condition.numberLessThanEquals('$.avg', 10), desire2
                //     .next(snsScaleOut
                // ))
                .when(sfn.Condition.numberGreaterThanEquals("$.avg", desireDone), isDone)
                .otherwise(wait3.next(getEcsTasks)));
            new sfn.StateMachine(this, "FargateAutoscaler", {
                definition: chain,
                timeout: core.Duration.hours(24),
            });
            new core.CfnOutput(this, "ClusterARN: ", {
                value: props.cluster.clusterArn,
            });
            new core.CfnOutput(this, "FargateWatcherLambdaArn: ", {
                value: fargateWatcherFunc.functionArn,
            });
        }
        if (props.scaleType == 'Ram') {
            // Todo function sacling by Ram
        }
        if (props.scaleType == 'CPU') {
            // Todo function sacling by cpu
        }
    }
}
exports.FargateAutoscalerStack = FargateAutoscalerStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFyZ2F0ZS1hdXRvc2NhbGVyLWNvbnN0cnVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImZhcmdhdGUtYXV0b3NjYWxlci1jb25zdHJ1Y3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsc0NBQXNDO0FBQ3RDLDhDQUE4QztBQUM5Qyw2QkFBNkI7QUFDN0Isd0NBQXdDO0FBQ3hDLHdDQUF3QztBQUV4QyxrREFBa0Q7QUFDbEQsOERBQThEO0FBQzlELHdDQUF3QztBQUV4QyxxREFBK0Q7QUFpQi9ELE1BQWEsc0JBQXVCLFNBQVEsSUFBSSxDQUFDLFNBQVM7SUFDeEQsWUFDRSxNQUFnQixFQUNoQixJQUFZLEVBQ1osS0FBNkI7O1FBRTdCLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFFLENBQUM7UUFFckIsTUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxZQUFZLEVBQUU7WUFDbEQsU0FBUyxFQUFFLElBQUksR0FBRyxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDO1NBQzVELENBQUMsQ0FBQztRQUNILFVBQVUsQ0FBQyxnQkFBZ0IsQ0FDekIsR0FBRyxDQUFDLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyxzQkFBc0IsQ0FBQyxDQUNuRSxDQUFDO1FBQ0YsVUFBVSxDQUFDLGdCQUFnQixDQUN6QixHQUFHLENBQUMsYUFBYSxDQUFDLHdCQUF3QixDQUFDLHlCQUF5QixDQUFDLENBQ3RFLENBQUM7UUFFRixVQUFVLENBQUMsV0FBVyxDQUNwQixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDdEIsU0FBUyxFQUFFLENBQUMsR0FBRyxDQUFDO1lBQ2hCLE9BQU8sRUFBRTtnQkFDUCw0QkFBNEI7Z0JBQzVCLCtCQUErQjtnQkFDL0IsNEJBQTRCO2FBQzdCO1NBQ0YsQ0FBQyxDQUNILENBQUM7UUFFRixVQUFVLENBQUMsV0FBVyxDQUNwQixJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFD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QixFQUFFO2dCQUNwRCxLQUFLLEVBQUUsa0JBQWtCLENBQUMsV0FBVzthQUN0QyxDQUFDLENBQUM7U0FDSjtRQUVELElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxLQUFLLEVBQUU7WUFDNUIsK0JBQStCO1NBQ2hDO1FBRUQsSUFBSSxLQUFLLENBQUMsU0FBUyxJQUFJLEtBQUssRUFBRTtZQUM1QiwrQkFBK0I7U0FDaEM7SUFFSCxDQUFDO0NBQ0Y7QUF0TkQsd0RBc05DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY29yZSBmcm9tIFwiQGF3cy1jZGsvY29yZVwiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJAYXdzLWNkay9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSBcIkBhd3MtY2RrL2F3cy1pYW1cIjtcbmltcG9ydCAqIGFzIGVjMiBmcm9tIFwiQGF3cy1jZGsvYXdzLWVjMlwiO1xuaW1wb3J0ICogYXMgZWNzIGZyb20gXCJAYXdzLWNkay9hd3MtZWNzXCI7XG5pbXBvcnQgKiBhcyBzZm4gZnJvbSBcIkBhd3MtY2RrL2F3cy1zdGVwZnVuY3Rpb25zXCI7XG5pbXBvcnQgKiBhcyBzZm5fdGFza3MgZnJvbSBcIkBhd3MtY2RrL2F3cy1zdGVwZnVuY3Rpb25zLXRhc2tzXCI7XG5pbXBvcnQgKiBhcyBzbnMgZnJvbSBcIkBhd3MtY2RrL2F3cy1zbnNcIjtcblxuaW1wb3J0IHsgYXBwbGljYXRpb25NZXRhRGF0YSB9IGZyb20gXCIuLi9jb25maWd1cmF0aW9ucy9jb25maWdcIjtcblxuLy8gY29uc3QgQVdTQ0xJX0xBWUVSX0FSTiA9IFwiYXJuOmF3czpzZXJ2ZXJsZXNzcmVwbzp1cy1lYXN0LTE6OTAzNzc5NDQ4NDI2OmFwcGxpY2F0aW9ucy9sYW1iZGEtbGF5ZXItYXdzY2xpXCI7XG4vLyBjb25zdCBBV1NDTElfTEFZRVJfVkVSU0lPTiA9IFwiMS4xOC4xNDJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBGYXJnYXRlQXV0b3NjYWxlclByb3BzIGV4dGVuZHMgY29yZS5TdGFja1Byb3BzIHtcbiAgcmVhZG9ubHkgdnBjOiBlYzIuSVZwYztcbiAgcmVhZG9ubHkgY2x1c3RlcjogZWNzLkNsdXN0ZXI7XG4gIHJlYWRvbmx5IGZnU2VydmljZTogZWNzLkZhcmdhdGVTZXJ2aWNlO1xuICByZWFkb25seSBzY2FsZVR5cGU6IHN0cmluZztcbiAgcmVhZG9ubHkgYXdzQ2xpTGF5ZXJBcm4/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGF3c0NsaUxheWVyVmVyc2lvbj86IHN0cmluZzsgXG4gIHJlYWRvbmx5IGRpc2FibGVTY2FsZUluPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgc25zVG9waWM/OiBzbnMuSVRvcGljO1xuICByZWFkb25seSB0aW1lb3V0ID86IGNvcmUuRHVyYXRpb247XG59IFxuXG5leHBvcnQgY2xhc3MgRmFyZ2F0ZUF1dG9zY2FsZXJTdGFjayBleHRlbmRzIGNvcmUuQ29uc3RydWN0IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcGFyZW50OiBjb3JlLkFwcCxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgcHJvcHM6IEZhcmdhdGVBdXRvc2NhbGVyUHJvcHNcbiAgKSB7XG4gICAgc3VwZXIocGFyZW50LCBuYW1lICk7XG4gICAgXG4gICAgY29uc3QgbGFtYmRhUm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBcImxhbWJkYVJvbGVcIiwge1xuICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoXCJsYW1iZGEuYW1hem9uYXdzLmNvbVwiKSxcbiAgICB9KTtcbiAgICBsYW1iZGFSb2xlLmFkZE1hbmFnZWRQb2xpY3koXG4gICAgICBpYW0uTWFuYWdlZFBvbGljeS5mcm9tQXdzTWFuYWdlZFBvbGljeU5hbWUoXCJBbWF6b25FQ1NfRnVsbEFjY2Vzc1wiKVxuICAgICk7XG4gICAgbGFtYmRhUm9sZS5hZGRNYW5hZ2VkUG9saWN5KFxuICAgICAgaWFtLk1hbmFnZWRQb2xpY3kuZnJvbUF3c01hbmFnZWRQb2xpY3lOYW1lKFwiQW1hem9uRUMyUmVhZE9ubHlBY2Nlc3NcIilcbiAgICApO1xuXG4gICAgbGFtYmRhUm9sZS5hZGRUb1BvbGljeShcbiAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgcmVzb3VyY2VzOiBbXCIqXCJdLFxuICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgXCJlYzI6Q3JlYXRlTmV0d29ya0ludGVyZmFjZVwiLFxuICAgICAgICAgIFwiZWMyOkRlc2NyaWJlTmV0d29ya0ludGVyZmFjZXNcIixcbiAgICAgICAgICBcImVjMjpEZWxldGVOZXR3b3JrSW50ZXJmYWNlXCIsXG4gICAgICAgIF0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICBsYW1iZGFSb2xlLmFkZFRvUG9saWN5KFxuICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICByZXNvdXJjZXM6IFtcIipcIl0sXG4gICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICBcImxvZ3M6Q3JlYXRlTG9nR3JvdXBcIixcbiAgICAgICAgICBcImxvZ3M6Q3JlYXRlTG9nU3RyZWFtXCIsXG4gICAgICAgICAgXCJsb2dzOlB1dExvZ0V2ZW50c1wiLFxuICAgICAgICBdLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29yZS5TdGFjay5vZih0aGlzKS50ZW1wbGF0ZU9wdGlvbnMudHJhbnNmb3JtcyA9IFtcbiAgICAgIFwiQVdTOjpTZXJ2ZXJsZXNzLTIwMTYtMTAtMzFcIixcbiAgICBdOyAvLyByZXF1aXJlZCBmb3IgQVdTOjpTZXJ2ZXJsZXNzXG5cbiAgICBjb25zdCByZXNvdXJjZSA9IG5ldyBjb3JlLkNmblJlc291cmNlKHRoaXMsIFwiUmVzb3VyY2VcIiwge1xuICAgICAgdHlwZTogXCJBV1M6OlNlcnZlcmxlc3M6OkFwcGxpY2F0aW9uXCIsXG4gICAgICBwcm9wZXJ0aWVzOiB7XG4gICAgICAgIExvY2F0aW9uOiB7XG4gICAgICAgICAgQXBwbGljYXRpb25JZDogcHJvcHMuYXdzQ2xpTGF5ZXJBcm4gLFxuICAgICAgICAgIFNlbWFudGljVmVyc2lvbjogcHJvcHMuYXdzQ2xpTGF5ZXJWZXJzaW9uICxcbiAgICAgICAgfSxcbiAgICAgICAgUGFyYW1ldGVyczoge30sXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgbGV0IGxheWVyVmVyc2lvbkFybiA9IGNvcmUuVG9rZW4uYXNTdHJpbmcoXG4gICAgICByZXNvdXJjZS5nZXRBdHQoXCJPdXRwdXRzLkxheWVyVmVyc2lvbkFyblwiKVxuICAgICk7XG4gICAgXG4gICAgLy8gY3JlYXRlIGEgc2VjdXJpdHkgZ3JvdXAgdGhhdCBhbGxvd3MgYWxsIHRyYWZmaWMgZnJvbSB0aGUgc2FtZSBzZ1xuICAgIGNvbnN0IHNnID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKHRoaXMsICdTaGFyZWRTZWN1cml0eUdyb3VwJywge1xuICAgICAgdnBjOiBwcm9wcy52cGMsXG4gICAgfSk7XG4gICAgc2cuY29ubmVjdGlvbnMuYWxsb3dGcm9tKHNnLCBlYzIuUG9ydC5hbGxUcmFmZmljKCkpO1xuICAgIFxuICAgIGlmIChwcm9wcy5zY2FsZVR5cGUgPT0gJ0Nvbm5lY3Rpb24nKSB7XG4gICAgXG4gICAgICBjb25zdCBmYXJnYXRlV2F0Y2hlckZ1bmMgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsIFwiZmFyZ2F0ZVdhdGNoZXJGdW5jXCIsIHtcbiAgICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuUFJPVklERUQsXG4gICAgICAgIGhhbmRsZXI6IFwibWFpblwiLFxuICAgICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQoXG4gICAgICAgICAgcGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLi9zYW0vZmFyZ2F0ZVdhdGNoZXJGdW5jL2Z1bmMuZFwiKVxuICAgICAgICApLFxuICAgICAgICBsYXllcnM6IFtcbiAgICAgICAgICBsYW1iZGEuTGF5ZXJWZXJzaW9uLmZyb21MYXllclZlcnNpb25Bcm4oXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgXCJBd3NDbGlMYXllclwiLFxuICAgICAgICAgICAgbGF5ZXJWZXJzaW9uQXJuXG4gICAgICAgICAgKSxcbiAgICAgICAgXSxcbiAgICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgICAgdGltZW91dDogY29yZS5EdXJhdGlvbi5taW51dGVzKDEpLFxuICAgICAgICByb2xlOiBsYW1iZGFSb2xlLFxuICAgICAgICB2cGM6IHByb3BzLnZwYyxcbiAgICAgICAgLy8gRklYTUVcbiAgICAgICAgLy8gdnBjU3VibmV0czogeyBzdWJuZXRUeXBlOiBlYzIuU3VibmV0VHlwZS5QUklWQVRFIH0sXG4gICAgICAgIHNlY3VyaXR5R3JvdXA6IHNnLFxuICAgICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICAgIGNsdXN0ZXI6IHByb3BzLmNsdXN0ZXIuY2x1c3Rlck5hbWUsXG4gICAgICAgICAgc2VydmljZTogcHJvcHMuZmdTZXJ2aWNlLnNlcnZpY2VOYW1lLFxuICAgICAgICAgIGRpc2FibGVfc2NhbGVpbjogcHJvcHMuZGlzYWJsZVNjYWxlSW4gPT09IGZhbHNlID8gXCJub1wiIDogXCJ5ZXNcIixcbiAgICAgICAgICAvLyByZWdpb246IHRoaXMucmVnaW9uLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gIFxuICAgICAgLy8gc3RlcCBmdW5jdGlvblxuICAgICAgY29uc3Qgd2FpdDMgPSBuZXcgc2ZuLldhaXQodGhpcywgXCJXYWl0IFwiICsgYXBwbGljYXRpb25NZXRhRGF0YS50aW1lVG9OZXh0Q2hlY2tlciArIFwiIFNlY29uZHNcIiwge1xuICAgICAgICAvLyB0aW1lOiBzZm4uV2FpdFRpbWUuc2Vjb25kc1BhdGgoJyQud2FpdF90aW1lJylcbiAgICAgICAgdGltZTogc2ZuLldhaXRUaW1lLmR1cmF0aW9uKGNvcmUuRHVyYXRpb24uc2Vjb25kcyhhcHBsaWNhdGlvbk1ldGFEYXRhLnRpbWVUb05leHRDaGVja2VyKSksXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHdhaXQ2MCA9IG5ldyBzZm4uV2FpdCh0aGlzLCBcIldhaXQgXCIrIGFwcGxpY2F0aW9uTWV0YURhdGEud2FpdEZvclNhY2xlRG9uZSArIFwiIFNlY29uZHNcIiwge1xuICAgICAgICB0aW1lOiBzZm4uV2FpdFRpbWUuZHVyYXRpb24oY29yZS5EdXJhdGlvbi5zZWNvbmRzKGFwcGxpY2F0aW9uTWV0YURhdGEud2FpdEZvclNhY2xlRG9uZSkpLFxuICAgICAgfSk7XG4gIFxuICAgICAgY29uc3QgZ2V0RWNzVGFza3MgPSBuZXcgc2ZuLlRhc2sodGhpcywgXCJHZXRFQ1NUYXNrc1wiLCB7XG4gICAgICAgIHRhc2s6IG5ldyBzZm5fdGFza3MuSW52b2tlRnVuY3Rpb24oZmFyZ2F0ZVdhdGNoZXJGdW5jKSxcbiAgICAgICAgcmVzdWx0UGF0aDogXCIkLnN0YXR1c1wiLFxuICAgICAgfSk7XG4gIFxuICAgICAgY29uc3QgdG9waWMgPVxuICAgICAgICBwcm9wcy5zbnNUb3BpYyA/P1xuICAgICAgICBuZXcgc25zLlRvcGljKHRoaXMsIGAke25hbWV9LXRvcGljYCwge1xuICAgICAgICAgIHRvcGljTmFtZTogYCR7Y29yZS5TdGFjay5vZih0aGlzKS5zdGFja05hbWV9LSR7bmFtZX1gLFxuICAgICAgICB9KTtcbiAgXG4gICAgICBjb25zdCBzbnNTY2FsZU91dCA9IG5ldyBzZm4uVGFzayh0aGlzLCBcIlNOU1NjYWxlT3V0XCIsIHtcbiAgICAgICAgdGFzazogbmV3IHNmbl90YXNrcy5QdWJsaXNoVG9Ub3BpYyh0b3BpYywge1xuICAgICAgICAgIC8vIG1lc3NhZ2U6IHNmbi5UYXNrSW5wdXQuZnJvbURhdGFBdCgnJCcpLFxuICAgICAgICAgIG1lc3NhZ2U6IHNmbi5UYXNrSW5wdXQuZnJvbU9iamVjdCh7XG4gICAgICAgICAgICBcIklucHV0LiRcIjogXCIkXCIsXG4gICAgICAgICAgfSksXG4gICAgICAgICAgc3ViamVjdDogXCJGYXJnYXRlIFN0YXJ0IFNjYWxpbmcgT3V0XCIsXG4gICAgICAgIH0pLFxuICAgICAgICByZXN1bHRQYXRoOiBcIiQudGFza3Jlc3VsdFwiLFxuICAgICAgfSk7XG4gIFxuICAgICAgY29uc3Qgc3ZjU2NhbGVPdXQgPSBuZXcgc2ZuLlRhc2sodGhpcywgXCJTZXJ2aWNlU2NhbGVPdXRcIiwge1xuICAgICAgICB0YXNrOiBuZXcgc2ZuX3Rhc2tzLkludm9rZUZ1bmN0aW9uKFxuICAgICAgICAgIGxhbWJkYS5GdW5jdGlvbi5mcm9tRnVuY3Rpb25Bcm4oXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgXCJzdmNTY2FsZU91dFwiLFxuICAgICAgICAgICAgZmFyZ2F0ZVdhdGNoZXJGdW5jLmZ1bmN0aW9uQXJuXG4gICAgICAgICAgKVxuICAgICAgICApLFxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGxldCBkZXNpcmVMdjEgPSBhcHBsaWNhdGlvbk1ldGFEYXRhLmRlc2lyZUx2MS5zcGxpdChcIl9cIik7XG4gICAgICBsZXQgZGVzaXJlTHYyID0gYXBwbGljYXRpb25NZXRhRGF0YS5kZXNpcmVMdjIuc3BsaXQoXCJfXCIpO1xuICAgICAgbGV0IGRlc2lyZUx2MyA9IGFwcGxpY2F0aW9uTWV0YURhdGEuZGVzaXJlTHYzLnNwbGl0KFwiX1wiKTtcbiAgICAgIGxldCBkZXNpcmVMdjQgPSBhcHBsaWNhdGlvbk1ldGFEYXRhLmRlc2lyZUx2NC5zcGxpdChcIl9cIik7XG4gICAgICBsZXQgZGVzaXJlRG9uZSA9IE51bWJlciAoYXBwbGljYXRpb25NZXRhRGF0YS5kZXNpcmVEb25lKTtcbiAgICAgIFxuICAgICAgXG4gICAgICBjb25zdCBpc1NlcnZpY2VPdmVybG9hZGVkID0gbmV3IHNmbi5DaG9pY2UodGhpcywgXCJJc1NlcnZpY2VPdmVybG9hZGVkXCIsIHtcbiAgICAgICAgaW5wdXRQYXRoOiBcIiQuc3RhdHVzXCIsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGlzRG9uZSA9IG5ldyBzZm4uUGFzcyh0aGlzLCBcIkRvbmVcIik7XG4gIFxuICAgICAgY29uc3QgZGVzaXJlX2x2MSA9IG5ldyBzZm4uUGFzcyh0aGlzLCBcIkRlc2lyZVwiICsgZGVzaXJlTHYxWzFdLCB7XG4gICAgICAgIG91dHB1dFBhdGg6IFwiJFwiLFxuICAgICAgICByZXN1bHQ6IHNmbi5SZXN1bHQuZnJvbU9iamVjdCh7IERlc2lyZWQ6IGRlc2lyZUx2MVsxXSB9KSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgZGVzaXJlX2x2MiA9IG5ldyBzZm4uUGFzcyh0aGlzLCBcIkRlc2lyZVwiICsgZGVzaXJlTHYyWzFdLCB7XG4gICAgICAgIG91dHB1dFBhdGg6IFwiJFwiLFxuICAgICAgICByZXN1bHQ6IHNmbi5SZXN1bHQuZnJvbU9iamVjdCh7IERlc2lyZWQ6IGRlc2lyZUx2MlsxXSB9KSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgZGVzaXJlX2x2MyA9IG5ldyBzZm4uUGFzcyh0aGlzLCBcIkRlc2lyZVwiICsgZGVzaXJlTHYzWzFdLCB7XG4gICAgICAgIG91dHB1dFBhdGg6IFwiJFwiLFxuICAgICAgICByZXN1bHQ6IHNmbi5SZXN1bHQuZnJvbU9iamVjdCh7IERlc2lyZWQ6IGRlc2lyZUx2M1sxXSB9KSxcbiAgICAgIH0pO1xuICAgICAgY29uc3QgZGVzaXJlX2x2NCA9IG5ldyBzZm4uUGFzcyh0aGlzLCBcIkRlc2lyZVwiICsgZGVzaXJlTHY0WzFdLCB7XG4gICAgICAgIG91dHB1dFBhdGg6IFwiJFwiLFxuICAgICAgICByZXN1bHQ6IHNmbi5SZXN1bHQuZnJvbU9iamVjdCh7IERlc2lyZWQ6IGRlc2lyZUx2NFsxXSB9KSxcbiAgICAgIH0pO1xuICBcbiAgICAgIGNvbnN0IGNoYWluID0gc2ZuLkNoYWluLnN0YXJ0KGdldEVjc1Rhc2tzKS5uZXh0KFxuICAgICAgICBpc1NlcnZpY2VPdmVybG9hZGVkXG4gICAgICAgICAgLndoZW4oXG4gICAgICAgICAgICBzZm4uQ29uZGl0aW9uLm51bWJlckdyZWF0ZXJUaGFuRXF1YWxzKFwiJC5hdmdcIiwgTnVtYmVyKGRlc2lyZUx2NFswXSkpLFxuICAgICAgICAgICAgZGVzaXJlX2x2NC5uZXh0KFxuICAgICAgICAgICAgICBzbnNTY2FsZU91dC5uZXh0KHN2Y1NjYWxlT3V0Lm5leHQod2FpdDYwLm5leHQoZ2V0RWNzVGFza3MpKSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgICAgLndoZW4oXG4gICAgICAgICAgICBzZm4uQ29uZGl0aW9uLm51bWJlckdyZWF0ZXJUaGFuRXF1YWxzKFwiJC5hdmdcIiwgTnVtYmVyKGRlc2lyZUx2M1swXSkpLFxuICAgICAgICAgICAgZGVzaXJlX2x2My5uZXh0KHNuc1NjYWxlT3V0KVxuICAgICAgICAgIClcbiAgICAgICAgICAud2hlbihcbiAgICAgICAgICAgIHNmbi5Db25kaXRpb24ubnVtYmVyR3JlYXRlclRoYW5FcXVhbHMoXCIkLmF2Z1wiLCBOdW1iZXIoZGVzaXJlTHYyWzBdKSksXG4gICAgICAgICAgICBkZXNpcmVfbHYyLm5leHQoc25zU2NhbGVPdXQpXG4gICAgICAgICAgKVxuICAgICAgICAgIC53aGVuKFxuICAgICAgICAgICAgc2ZuLkNvbmRpdGlvbi5udW1iZXJHcmVhdGVyVGhhbkVxdWFscyhcIiQuYXZnXCIsIE51bWJlcihkZXNpcmVMdjFbMF0pKSxcbiAgICAgICAgICAgIGRlc2lyZV9sdjEubmV4dChzbnNTY2FsZU91dClcbiAgICAgICAgICApXG4gICAgICAgICAgLy8gLndoZW4oc2ZuLkNvbmRpdGlvbi5udW1iZXJMZXNzVGhhbkVxdWFscygnJC5hdmcnLCAxMCksIGRlc2lyZTJcbiAgICAgICAgICAvLyAgICAgLm5leHQoc25zU2NhbGVPdXRcbiAgICAgICAgICAvLyApKVxuICAgICAgICAgIC53aGVuKHNmbi5Db25kaXRpb24ubnVtYmVyR3JlYXRlclRoYW5FcXVhbHMoXCIkLmF2Z1wiLCBkZXNpcmVEb25lKSwgaXNEb25lKVxuICAgICAgICAgIC5vdGhlcndpc2Uod2FpdDMubmV4dChnZXRFY3NUYXNrcykpXG4gICAgICApO1xuICBcbiAgICAgIG5ldyBzZm4uU3RhdGVNYWNoaW5lKHRoaXMsIFwiRmFyZ2F0ZUF1dG9zY2FsZXJcIiwge1xuICAgICAgICBkZWZpbml0aW9uOiBjaGFpbixcbiAgICAgICAgdGltZW91dDogY29yZS5EdXJhdGlvbi5ob3VycygyNCksXG4gICAgICB9KTtcbiAgXG4gICAgICBuZXcgY29yZS5DZm5PdXRwdXQodGhpcywgXCJDbHVzdGVyQVJOOiBcIiwge1xuICAgICAgICB2YWx1ZTogcHJvcHMuY2x1c3Rlci5jbHVzdGVyQXJuLFxuICAgICAgfSk7XG4gICAgICBuZXcgY29yZS5DZm5PdXRwdXQodGhpcywgXCJGYXJnYXRlV2F0Y2hlckxhbWJkYUFybjogXCIsIHtcbiAgICAgICAgdmFsdWU6IGZhcmdhdGVXYXRjaGVyRnVuYy5mdW5jdGlvbkFybixcbiAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBpZiAocHJvcHMuc2NhbGVUeXBlID09ICdSYW0nKSB7XG4gICAgICAvLyBUb2RvIGZ1bmN0aW9uIHNhY2xpbmcgYnkgUmFtXG4gICAgfVxuICAgIFxuICAgIGlmIChwcm9wcy5zY2FsZVR5cGUgPT0gJ0NQVScpIHtcbiAgICAgIC8vIFRvZG8gZnVuY3Rpb24gc2FjbGluZyBieSBjcHVcbiAgICB9XG4gICAgXG4gIH1cbn0iXX0=